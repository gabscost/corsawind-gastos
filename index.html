<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corsa Wind ‚Äî Controle de Gastos</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f2ee;
    --surface: #ffffff;
    --card: #faf8f5;
    --border: #e8e2d9;
    --accent: #c0392b;
    --accent2: #e74c3c;
    --dark: #1a1208;
    --text: #2c2416;
    --muted: #8a7d6b;
    --green: #27ae60;
    --yellow: #f39c12;
    --shadow: 0 2px 20px rgba(26,18,8,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: var(--dark);
    padding: 0 32px;
    display: flex;
    align-items: stretch;
    height: 70px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.3);
  }
  .header-left {
    display: flex;
    align-items: center;
    gap: 14px;
    flex: 1;
  }
  .logo-plate {
    background: var(--accent);
    color: white;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 2px;
    padding: 4px 10px;
    border-radius: 4px;
    border: 2px solid rgba(255,255,255,0.2);
  }
  header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 26px;
    color: white;
    letter-spacing: 2px;
  }
  header h1 span { color: var(--accent2); }
  .header-status {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #888;
    flex-shrink: 0;
  }
  @media (max-width: 500px) {
    .header-status span { display: none; }
  }
  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #555;
    transition: background 0.3s;
  }
  .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.loading { background: var(--yellow); animation: blink 0.8s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* STATS BAR */
  .stats-bar {
    background: white;
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
    gap: 0;
    overflow-x: auto;
  }
  .stat {
    padding: 16px 28px;
    border-right: 1px solid var(--border);
    min-width: 150px;
    flex-shrink: 0;
  }
  .stat:first-child { padding-left: 0; }
  .stat-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    color: var(--text);
    letter-spacing: 1px;
    line-height: 1;
  }
  .stat-value.red { color: var(--accent); }
  .stat-value.green { color: var(--green); }

  /* MAIN LAYOUT */
  .main {
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 24px;
    padding: 24px 32px;
    max-width: 1200px;
    margin: 0 auto;
  }
  @media (max-width: 800px) {
    .stats-bar { padding: 0 12px; }
    header { padding: 0 14px; }
    header h1 { font-size: 20px; }
    .logo-plate { font-size: 11px; padding: 3px 8px; }
    .stat { padding: 12px 16px; min-width: 110px; }
    .stat-value { font-size: 17px; }
    .field-row { grid-template-columns: 1fr 1fr; }
    .list-header { flex-direction: column; align-items: flex-start; gap: 10px; }
    .gasto-item { padding: 12px 14px; gap: 10px; }
    .gasto-val { font-size: 16px; }
    .cat-icon { width: 36px; height: 36px; font-size: 15px; }
    .form-body { padding: 16px; }
    .list-header { padding: 14px 16px; }

    /* Mobile: formul√°rio e hist√≥rico viram sub-abas */
    .main {
      display: block;
      padding: 0;
    }
    .mobile-subtabs {
      display: flex;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    .mobile-subtab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mobile-subtab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .mobile-panel { display: none; padding: 12px; }
    .mobile-panel.active { display: block; }
    .form-card { position: static; border-radius: 12px; }
    .list-card { border-radius: 12px; }
  }
  @media (min-width: 801px) {
    .mobile-subtabs { display: none; }
    .mobile-panel { display: contents; }
    .main { display: grid; grid-template-columns: 360px 1fr; gap: 24px; padding: 24px 32px; max-width: 1200px; margin: 0 auto; }
    .form-card { position: sticky; top: 94px; }
  }

  /* FORM CARD */
  .form-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow);
    height: fit-content;
    position: sticky;
    top: 94px;
  }
  .form-card-header {
    background: var(--dark);
    padding: 18px 24px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .form-card-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    color: white;
    letter-spacing: 1.5px;
  }
  .form-body { padding: 20px 24px 24px; }

  .field { margin-bottom: 14px; }
  .field label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .field input, .field select, .field textarea {
    width: 100%;
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--text);
    font-size: 14px;
    font-family: 'Nunito', sans-serif;
    font-weight: 500;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(192,57,43,0.08);
  }
  .field textarea { resize: vertical; min-height: 70px; }

  .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .btn-save {
    width: 100%;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 13px;
    font-size: 14px;
    font-weight: 700;
    font-family: 'Nunito', sans-serif;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 4px;
  }
  .btn-save:hover { background: #a93226; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(192,57,43,0.3); }
  .btn-save:active { transform: translateY(0); }
  .btn-save:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

  /* LIST CARD */
  .list-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }
  .list-header {
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .list-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    color: var(--text);
    letter-spacing: 1.5px;
  }
  .filter-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .filter-btn {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 20px;
    padding: 5px 14px;
    font-size: 11px;
    font-weight: 700;
    color: var(--muted);
    cursor: pointer;
    font-family: 'Nunito', sans-serif;
    letter-spacing: 0.5px;
    transition: all 0.15s;
  }
  .filter-btn.active, .filter-btn:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  /* ITEMS */
  .gastos-list { min-height: 200px; }
  .gasto-item {
    display: flex;
    align-items: center;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    gap: 14px;
    transition: background 0.15s;
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .gasto-item:hover { background: var(--card); }
  .gasto-item:last-child { border-bottom: none; }

  .cat-icon {
    width: 42px; height: 42px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .gasto-info { flex: 1; min-width: 0; }
  .gasto-desc {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gasto-meta {
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
    display: flex;
    gap: 8px;
  }
  .cat-badge {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }
  .gasto-val {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    color: var(--accent);
    letter-spacing: 1px;
    flex-shrink: 0;
  }
  .del-btn {
    background: none;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    width: 32px; height: 32px;
    cursor: pointer;
    color: var(--muted);
    font-size: 14px;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .del-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(192,57,43,0.05); }

  /* EMPTY / LOADING */
  .empty-state {
    padding: 50px 24px;
    text-align: center;
    color: var(--muted);
  }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--dark);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.error { background: var(--accent); }

  /* CAT COLORS */
  .c-combustivel { background: #fef3e8; color: #e67e22; }
  .c-manutencao  { background: #e8f4fd; color: #2980b9; }
  .c-revisao     { background: #f0e8fd; color: #8e44ad; }
  .c-pneus       { background: #e8fdf0; color: #27ae60; }
  .c-seguro      { background: #fdf8e8; color: #f39c12; }
  .c-ipva        { background: #fde8e8; color: #c0392b; }
  .c-multa       { background: #fde8e8; color: #c0392b; }
  .c-lavagem     { background: #e8fdfc; color: #16a085; }
  .c-pecas       { background: #f5e8fd; color: #7d3c98; }
  .c-outros      { background: #f0f0f0; color: #7f8c8d; }

  select option { font-family: 'Nunito', sans-serif; }

  /* NAV TABS */
  .nav-tabs {
    background: white;
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
  }
  .nav-tab {
    padding: 14px 22px;
    font-size: 13px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 0.5px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 7px;
    user-select: none;
  }
  .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .nav-tab:hover:not(.active) { color: var(--text); }
  @media (max-width: 800px) {
    .nav-tabs { padding: 0 12px; }
    .nav-tab { padding: 12px 14px; font-size: 12px; }
  }
  .page { display: none; }
  .page.active { display: block; }

  /* DASHBOARD */
  .dash-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    padding: 24px 32px 0;
    max-width: 1200px;
    margin: 0 auto;
  }
  @media (max-width: 800px) { .dash-grid { grid-template-columns: 1fr 1fr; padding: 12px 12px 0; gap: 12px; } }
  @media (max-width: 480px) { .dash-grid { grid-template-columns: 1fr; } }

  .dash-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }
  .dash-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--accent);
    border-radius: 14px 14px 0 0;
  }
  .dash-card.green::before { background: var(--green); }
  .dash-card.yellow::before { background: var(--yellow); }
  .dash-card-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  .dash-card-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    color: var(--text);
    letter-spacing: 1px;
    line-height: 1;
  }
  .dash-card-value.red { color: var(--accent); }
  .dash-card-value.green { color: var(--green); }
  .dash-card-value.yellow { color: var(--yellow); }
  .dash-card-sub { font-size: 12px; color: var(--muted); margin-top: 6px; }
  .dash-card-trend { position: absolute; top: 18px; right: 18px; font-size: 22px; }

  .chart-section {
    padding: 20px 32px 32px;
    max-width: 1200px;
    margin: 0 auto;
  }
  @media (max-width: 800px) { .chart-section { padding: 16px 12px 24px; } }
  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px;
    box-shadow: var(--shadow);
  }
  .chart-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }
  .chart-card-header h3 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 1.5px;
    color: var(--text);
  }
  .year-select {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 13px;
    font-family: 'Nunito', sans-serif;
    font-weight: 600;
    color: var(--text);
    outline: none;
    cursor: pointer;
  }
  .chart-wrap { position: relative; height: 260px; }
  @media (max-width: 600px) { .chart-wrap { height: 190px; } }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo-plate">MG¬∑4321</div>
    <h1>CORSA <span>WIND</span></h1>
  </div>
  <div class="header-status">
    <div class="status-dot loading" id="status-dot"></div>
    <span id="status-txt">conectando...</span>
  </div>
</header>

<div class="stats-bar">
  <div class="stat">
    <div class="stat-label">Total Gasto</div>
    <div class="stat-value red" id="stat-total">R$ 0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Lan√ßamentos</div>
    <div class="stat-value" id="stat-count">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Maior Gasto</div>
    <div class="stat-value" id="stat-maior">R$ 0</div>
  </div>
  <div class="stat">
    <div class="stat-label">√öltimo Registro</div>
    <div class="stat-value" id="stat-ultimo" style="font-size:16px;padding-top:4px">‚Äî</div>
  </div>
</div>


<div class="nav-tabs">
  <div class="nav-tab active" onclick="showPage('gastos', this)">üöó Gastos</div>
  <div class="nav-tab" onclick="showPage('dashboard', this)">üìä Dashboard</div>
</div>

<!-- PAGE: GASTOS -->
<div class="page active" id="page-gastos">
<div class="main">
  <!-- MOBILE SUB-TABS (only shown on mobile) -->
  <div class="mobile-subtabs">
    <div class="mobile-subtab active" onclick="showSubTab('adicionar', this)">‚ûï Adicionar</div>
    <div class="mobile-subtab" onclick="showSubTab('historico', this)">üìã Hist√≥rico</div>
  </div>
  <!-- PANEL ADICIONAR -->
  <div class="mobile-panel active" id="mpanel-adicionar">
  <div class="form-card">
    <div class="form-card-header">
      <span>‚ûï</span>
      <h2>Novo Gasto</h2>
    </div>
    <div class="form-body">
      <div class="field">
        <label>Categoria</label>
        <select id="f-cat">
          <option value="combustivel">‚õΩ Combust√≠vel</option>
          <option value="manutencao">üîß Manuten√ß√£o</option>
          <option value="revisao">üìã Revis√£o</option>
          <option value="pneus">üõû Pneus</option>
          <option value="seguro">üõ°Ô∏è Seguro</option>
          <option value="ipva">üìÑ IPVA / Licenciamento</option>
          <option value="multa">üö® Multa</option>
          <option value="lavagem">üßº Lavagem / Est√©tica</option>
          <option value="pecas">‚öôÔ∏è Pe√ßas</option>
          <option value="outros">üì¶ Outros</option>
        </select>
      </div>
      <div class="field">
        <label>Descri√ß√£o</label>
        <input id="f-desc" type="text" placeholder="ex: Troca de √≥leo 5W30">
      </div>
      <div class="field-row">
        <div class="field">
          <label>Valor (R$)</label>
          <input id="f-val" type="number" placeholder="0,00" step="0.01" min="0">
        </div>
        <div class="field">
          <label>KM Atual</label>
          <input id="f-km" type="number" placeholder="ex: 87500">
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>M√£o de Obra (R$)</label>
          <input id="f-mo" type="number" placeholder="0,00" step="0.01" min="0">
        </div>
        <div class="field">
          <label>Data</label>
          <input id="f-data" type="date">
        </div>
      </div>
      <div class="field">
        <label>Oficina / Local</label>
        <input id="f-local" type="text" placeholder="ex: Auto Pe√ßas Silva">
      </div>
      <div class="field">
        <label>Observa√ß√µes</label>
        <textarea id="f-obs" placeholder="Detalhes adicionais..."></textarea>
      </div>
      <button class="btn-save" id="btn-salvar" onclick="salvarGasto()">
        <span id="btn-icon">‚òÅÔ∏è</span>
        <span id="btn-txt">Salvar no Firebase</span>
      </button>
    </div>
  </div>

  </div><!-- end mobile-panel adicionar -->
  <!-- PANEL HISTORICO -->
  <div class="mobile-panel" id="mpanel-historico">
  <!-- LIST -->
  <div class="list-card">
    <div class="list-header">
      <h2>Hist√≥rico de Gastos</h2>
      <div class="filter-row">
        <button class="filter-btn active" onclick="filtrar('todos', this)">Todos</button>
        <button class="filter-btn" onclick="filtrar('combustivel', this)">‚õΩ</button>
        <button class="filter-btn" onclick="filtrar('manutencao', this)">üîß</button>
        <button class="filter-btn" onclick="filtrar('pneus', this)">üõû</button>
        <button class="filter-btn" onclick="filtrar('revisao', this)">üìã</button>
      </div>
    </div>
    <div class="gastos-list" id="gastos-list">
      <div class="empty-state">
        <div class="icon">üîÑ</div>
        <p>Conectando ao Firebase...</p>
      </div>
    </div>
  </div>
</div>


</div><!-- end page-gastos -->

<!-- PAGE: DASHBOARD -->
<div class="page" id="page-dashboard">
  <div class="dash-grid">
    <div class="dash-card">
      <div class="dash-card-trend">üìÖ</div>
      <div class="dash-card-label">Gasto Este M√™s</div>
      <div class="dash-card-value red" id="d-mes-atual">R$ 0</div>
      <div class="dash-card-sub" id="d-mes-atual-sub">0 lan√ßamentos</div>
    </div>
    <div class="dash-card green">
      <div class="dash-card-trend">üìÜ</div>
      <div class="dash-card-label">M√™s Anterior</div>
      <div class="dash-card-value" id="d-mes-ant">R$ 0</div>
      <div class="dash-card-sub" id="d-mes-ant-sub">0 lan√ßamentos</div>
    </div>
    <div class="dash-card yellow">
      <div class="dash-card-trend">üìä</div>
      <div class="dash-card-label">M√©dia Mensal</div>
      <div class="dash-card-value yellow" id="d-media">R$ 0</div>
      <div class="dash-card-sub" id="d-media-sub">considerando meses com gasto</div>
    </div>
  </div>

  <div class="chart-section">
    <div class="chart-card">
      <div class="chart-card-header">
        <h3>üìà Gastos por M√™s</h3>
        <select class="year-select" id="ano-select" onchange="renderDashboard()"></select>
      </div>
      <div class="chart-wrap">
        <canvas id="chart-mensal"></canvas>
      </div>
    </div>
  </div>
</div><!-- end page-dashboard -->
<div class="toast" id="toast"></div>

<!-- FIREBASE SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, deleteDoc,
    doc, onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // =============================================
  // SUAS CONFIGURA√á√ïES DO FIREBASE
  // =============================================
  const firebaseConfig = {
    apiKey:            "AIzaSyAhzc2OXw9Ny9dd6zfK4F_WItkZDdqjNyI",
    authDomain:        "fir-8afa1.firebaseapp.com",
    databaseURL:       "https://fir-8afa1-default-rtdb.firebaseio.com",
    projectId:         "fir-8afa1",
    storageBucket:     "fir-8afa1.firebasestorage.app",
    messagingSenderId: "345070082028",
    appId:             "1:345070082028:web:5fdd668d288997ea1b52c9"
  };
  // =============================================

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  let todosGastos = [];
  let filtroAtivo = 'todos';

  // Hoje como padr√£o no campo data
  document.getElementById('f-data').value = new Date().toISOString().split('T')[0];

  // STATUS
  function setStatus(online) {
    const dot = document.getElementById('status-dot');
    const txt = document.getElementById('status-txt');
    dot.className = 'status-dot ' + (online ? 'online' : '');
    txt.textContent = online ? 'Firebase conectado' : 'sem conex√£o';
  }

  // TOAST
  window.toast = function(msg, erro = false) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show' + (erro ? ' error' : '');
    setTimeout(() => el.className = 'toast', 3000);
  }

  // CATEGORIAS
  const catInfo = {
    combustivel: { label: 'Combust√≠vel',        icon: '‚õΩ', cls: 'c-combustivel' },
    manutencao:  { label: 'Manuten√ß√£o',          icon: 'üîß', cls: 'c-manutencao'  },
    revisao:     { label: 'Revis√£o',             icon: 'üìã', cls: 'c-revisao'     },
    pneus:       { label: 'Pneus',               icon: 'üõû', cls: 'c-pneus'       },
    seguro:      { label: 'Seguro',              icon: 'üõ°Ô∏è', cls: 'c-seguro'      },
    ipva:        { label: 'IPVA/Licenciamento',  icon: 'üìÑ', cls: 'c-ipva'        },
    multa:       { label: 'Multa',               icon: 'üö®', cls: 'c-multa'       },
    lavagem:     { label: 'Lavagem',             icon: 'üßº', cls: 'c-lavagem'     },
    pecas:       { label: 'Pe√ßas',               icon: '‚öôÔ∏è', cls: 'c-pecas'       },
    outros:      { label: 'Outros',              icon: 'üì¶', cls: 'c-outros'      },
  };

  // FORMATAR MOEDA
  function fmt(v) {
    return 'R$ ' + parseFloat(v||0).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  // ATUALIZAR STATS
  function atualizarStats(gastos) {
    const total  = gastos.reduce((s,g) => s + (g.valor||0), 0);
    const maior  = gastos.length ? Math.max(...gastos.map(g => g.valor||0)) : 0;
    const ultimo = gastos.length ? gastos[0] : null;

    document.getElementById('stat-total').textContent  = fmt(total);
    document.getElementById('stat-count').textContent  = gastos.length;
    document.getElementById('stat-maior').textContent  = fmt(maior);
    document.getElementById('stat-ultimo').textContent = ultimo
      ? new Date(ultimo.data + 'T12:00:00').toLocaleDateString('pt-BR', {day:'2-digit',month:'short'})
      : '‚Äî';
  }

  // RENDERIZAR LISTA
  function renderizar(gastos) {
    const list = document.getElementById('gastos-list');
    const filtrados = filtroAtivo === 'todos' ? gastos : gastos.filter(g => g.categoria === filtroAtivo);

    if (!filtrados.length) {
      list.innerHTML = `<div class="empty-state">
        <div class="icon">üöó</div>
        <p>${gastos.length ? 'Nenhum gasto nessa categoria.' : 'Nenhum gasto registrado ainda.<br>Adicione o primeiro!'}</p>
      </div>`;
      return;
    }

    list.innerHTML = filtrados.map(g => {
      const info = catInfo[g.categoria] || catInfo.outros;
      const dataFmt = g.data
        ? new Date(g.data + 'T12:00:00').toLocaleDateString('pt-BR')
        : '‚Äî';
      return `
        <div class="gasto-item">
          <div class="cat-icon ${info.cls}">${info.icon}</div>
          <div class="gasto-info">
            <div class="gasto-desc">${g.descricao || info.label}</div>
            <div class="gasto-meta">
              <span class="cat-badge ${info.cls}">${info.label}</span>
              <span>üìÖ ${dataFmt}</span>
              ${g.km ? `<span>üõ£Ô∏è ${Number(g.km).toLocaleString('pt-BR')} km</span>` : ''}
              ${g.local ? `<span>üìç ${g.local}</span>` : ''}
            </div>
          </div>
          <div class="gasto-val">${fmt(g.valor)}</div>
          <button class="del-btn" onclick="window.deletar('${g.id}')" title="Remover">‚úï</button>
        </div>`;
    }).join('');
  }

  // FILTRO
  window.filtrar = function(cat, btn) {
    filtroAtivo = cat;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderizar(todosGastos);
  }

  // SALVAR
  window.salvarGasto = async function() {
    const val = parseFloat(document.getElementById('f-val').value);
    const desc = document.getElementById('f-desc').value.trim();
    const cat  = document.getElementById('f-cat').value;

    if (!val || val <= 0) { toast('‚ö†Ô∏è Informe um valor v√°lido!', true); return; }

    const btn = document.getElementById('btn-salvar');
    btn.disabled = true;
    document.getElementById('btn-txt').textContent = 'Salvando...';
    document.getElementById('btn-icon').textContent = '‚è≥';

    try {
      await addDoc(collection(db, 'gastos'), {
        categoria: cat,
        descricao: desc || catInfo[cat]?.label || 'Gasto',
        valor:     val,
        mo:        parseFloat(document.getElementById('f-mo').value) || 0,
        km:        document.getElementById('f-km').value || '',
        data:      document.getElementById('f-data').value,
        local:     document.getElementById('f-local').value.trim(),
        obs:       document.getElementById('f-obs').value.trim(),
        criadoEm:  serverTimestamp()
      });

      // Limpar form
      document.getElementById('f-desc').value = '';
      document.getElementById('f-val').value  = '';
      document.getElementById('f-mo').value   = '';
      document.getElementById('f-km').value   = '';
      document.getElementById('f-local').value = '';
      document.getElementById('f-obs').value  = '';

      toast('‚úÖ Gasto salvo no Firebase!');
    } catch(e) {
      toast('‚ùå Erro ao salvar: ' + e.message, true);
      console.error(e);
    }

    btn.disabled = false;
    document.getElementById('btn-txt').textContent = 'Salvar no Firebase';
    document.getElementById('btn-icon').textContent = '‚òÅÔ∏è';
  }

  // DELETAR
  window.deletar = async function(id) {
    if (!confirm('Remover esse gasto?')) return;
    try {
      await deleteDoc(doc(db, 'gastos', id));
      toast('üóëÔ∏è Gasto removido');
    } catch(e) {
      toast('‚ùå Erro ao remover', true);
    }
  }

  // LISTENER EM TEMPO REAL
  const q = query(collection(db, 'gastos'), orderBy('criadoEm', 'desc'));
  onSnapshot(q,
    (snapshot) => {
      setStatus(true);
      todosGastos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      window._todosGastos = todosGastos;
      if (document.getElementById('page-dashboard').classList.contains('active')) {
        window.renderDashboard();
      }
      atualizarStats(todosGastos);
      renderizar(todosGastos);
    },
    (err) => {
      setStatus(false);
      console.error(err);
      document.getElementById('gastos-list').innerHTML = `
        <div class="empty-state">
          <div class="icon">‚ö†Ô∏è</div>
          <p>Erro ao conectar ao Firebase.<br><small>${err.message}</small></p>
        </div>`;
    }
  );
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
  // PAGE SWITCHER
  window.showPage = function(page, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    btn.classList.add('active');
    if (page === 'dashboard') renderDashboard();
  }

  // CHART instance
  let chartInstance = null;

  window.renderDashboard = function() {
    const gastos = window._todosGastos || [];
    const gastos_avail = gastos.length > 0;
    const anoSel = parseInt(document.getElementById('ano-select').value);
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();

    // Preenche anos dispon√≠veis
    const anos = [...new Set(gastos.map(g => g.data ? g.data.substring(0,4) : null).filter(Boolean))].sort().reverse();
    if (anos.length === 0) anos.push(String(anoAtual));
    const sel = document.getElementById('ano-select');
    const valorAtual = sel.value;
    sel.innerHTML = anos.map(a => `<option value="${a}" ${a == (valorAtual||anoAtual) ? 'selected':''}>${a}</option>`).join('');
    const anoFiltro = parseInt(sel.value) || anoAtual;

    // Gastos do ano selecionado
    const gastosAno = gastos.filter(g => g.data && g.data.startsWith(String(anoFiltro)));

    // Totais por m√™s
    const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    const totaisMes = Array(12).fill(0);
    const countMes  = Array(12).fill(0);
    gastosAno.forEach(g => {
      const m = parseInt(g.data.substring(5,7)) - 1;
      totaisMes[m] += g.valor || 0;
      countMes[m]++;
    });

    // Cards
    const fmt = v => 'R$ ' + parseFloat(v||0).toLocaleString('pt-BR', {minimumFractionDigits:2,maximumFractionDigits:2});
    if (anoFiltro === anoAtual) {
      const vMes = totaisMes[mesAtual];
      const vAnt = mesAtual > 0 ? totaisMes[mesAtual-1] : 0;
      document.getElementById('d-mes-atual').textContent = fmt(vMes);
      document.getElementById('d-mes-atual-sub').textContent = countMes[mesAtual] + ' lan√ßamento(s) em ' + meses[mesAtual];
      document.getElementById('d-mes-ant').textContent = fmt(vAnt);
      document.getElementById('d-mes-ant-sub').textContent = (mesAtual>0 ? countMes[mesAtual-1] : 0) + ' lan√ßamento(s) em ' + (mesAtual>0 ? meses[mesAtual-1] : '‚Äî');
    } else {
      const totalAno = totaisMes.reduce((a,b)=>a+b,0);
      document.getElementById('d-mes-atual').textContent = fmt(totalAno);
      document.getElementById('d-mes-atual-sub').textContent = 'total em ' + anoFiltro;
      document.getElementById('d-mes-ant').textContent = '‚Äî';
      document.getElementById('d-mes-ant-sub').textContent = 'ano diferente';
    }
    const mesesComGasto = totaisMes.filter(v => v > 0).length;
    const media = mesesComGasto ? totaisMes.reduce((a,b)=>a+b,0) / mesesComGasto : 0;
    document.getElementById('d-media').textContent = fmt(media);
    document.getElementById('d-media-sub').textContent = mesesComGasto + ' m√™s(es) com gasto em ' + anoFiltro;

    // Gr√°fico
    const ctx = document.getElementById('chart-mensal').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: meses,
        datasets: [{
          label: 'Gastos (R$)',
          data: totaisMes,
          backgroundColor: totaisMes.map((v,i) =>
            (anoFiltro === anoAtual && i === mesAtual) ? '#c0392b' : 'rgba(192,57,43,0.18)'
          ),
          borderColor: totaisMes.map((v,i) =>
            (anoFiltro === anoAtual && i === mesAtual) ? '#c0392b' : 'rgba(192,57,43,0.5)'
          ),
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => ' R$ ' + ctx.raw.toLocaleString('pt-BR', {minimumFractionDigits:2})
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' },
            ticks: {
              font: { family: 'Nunito', size: 11 },
              color: '#8a7d6b',
              callback: v => 'R$ ' + v.toLocaleString('pt-BR')
            }
          },
          x: {
            grid: { display: false },
            ticks: { font: { family: 'Nunito', weight: '600', size: 11 }, color: '#8a7d6b' }
          }
        }
      }
    });
  }
</script>

<script>
window.showSubTab = function(tab, btn) {
  document.querySelectorAll('.mobile-subtab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.mobile-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('mpanel-' + tab).classList.add('active');
}
</script>
</body>
</html>
